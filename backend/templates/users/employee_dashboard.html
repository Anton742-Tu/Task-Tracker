{% extends 'base.html' %}
{% load task_tags %}

{% block title %}–î–∞—à–±–æ—Ä–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ - Task Tracker{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div class="alert alert-info">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.get_full_name|default:user.username }}!</h4>
                <p class="mb-0">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. Email: {{ user.email }}</p>
                {% if user.telegram_chat_id %}
                <small class="text-success">‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã</small>
                {% else %}
                <small class="text-warning">‚ö†Ô∏è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</small>
                {% endif %}
            </div>
            <div>
                <a href="{% url 'employee_profile' %}" class="btn btn-outline-info">
                    üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </a>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{% url 'tasks:my_tasks' %}" class="btn btn-primary">
                            üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏ ({{ active_tasks.count }} –∞–∫—Ç–∏–≤–Ω—ã—Ö)
                        </a>
                        <a href="#" class="btn btn-outline-danger"
                           onclick="alert('–ß—Ç–æ–±—ã —Å–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É'); return false;">
                            üêû –°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ
                        </a>
                        <a href="#" class="btn btn-outline-warning"
                           onclick="alert('–ß—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É'); return false;">
                            üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ
                        </a>
                        <a href="#" class="btn btn-outline-secondary"
                           onclick="alert('–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É'); return false;">
                            üìù –õ–∏—á–Ω–∞—è –∑–∞–¥–∞—á–∞
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>–í—Å–µ–≥–æ –∑–∞–¥–∞—á</span>
                    <span class="badge bg-light text-dark">{{ tasks.count }}</span>
                </div>
                <div class="card-body text-center">
                    <h2 class="card-title">{{ tasks.count }}</h2>
                    <p class="card-text">–ù–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–∞ –≤–∞—Å</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>–í —Ä–∞–±–æ—Ç–µ</span>
                    <span class="badge bg-light text-dark">{{ active_tasks.count }}</span>
                </div>
                <div class="card-body text-center">
                    <h2 class="card-title">{{ active_tasks.count }}</h2>
                    <p class="card-text">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                    <span class="badge bg-light text-dark">{{ completed_tasks.count }}</span>
                </div>
                <div class="card-body text-center">
                    <h2 class="card-title">{{ completed_tasks.count }}</h2>
                    <p class="card-text">–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                    <span class="badge bg-light text-dark">{{ overdue_tasks.count }}</span>
                </div>
                <div class="card-body text-center">
                    <h2 class="card-title">{{ overdue_tasks.count }}</h2>
                    <p class="card-text">–¢—Ä–µ–±—É—é—Ç —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    {% if status_stats %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        {% for status, count in status_stats.items %}
                        <div class="col-md-2 col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="mb-1">{{ count }}</h3>
                                <small class="text-muted">
                                    {% if status == 'todo' %}üìã –ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
                                    {% elif status == 'in_progress' %}‚ö° –í —Ä–∞–±–æ—Ç–µ
                                    {% elif status == 'review' %}üëÄ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
                                    {% elif status == 'done' %}‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                    {% elif status == 'blocked' %}üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
                                    {% else %}{{ status|title }}{% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (—Å—Ä–æ—á–Ω—ã–µ/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ) -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üî• –°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)</h5>
        </div>
        <div class="card-body">
            {% if overdue_tasks or active_tasks %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-warning">
                        <tr>
                            <th width="30%">–ó–∞–¥–∞—á–∞</th>
                            <th>–ü—Ä–æ–µ–∫—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°—Ä–æ–∫</th>
                            <th width="20%">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in overdue_tasks|slice:":5" %}
                        <tr class="table-danger">
                            <td>
                                <strong class="text-danger">üö® {{ task.title }}</strong>
                                {% if task.description %}
                                <br><small class="text-muted">{{ task.description|truncatechars:50 }}</small>
                                {% endif %}
                            </td>
                            <td>{{ task.project.name|default:"–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞" }}</td>
                            <td>
                                <span class="badge bg-danger">
                                    {{ task.get_status_display }}
                                </span>
                            </td>
                            <td class="text-danger">
                                <strong>{{ task.due_date|date:"d.m.Y" }}</strong>
                                <br><small>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!</small>
                            </td>
                            <td>
                                {% if task|can_complete_task:user and task.status != 'done' %}
                                <form method="post"
                                      action="{% url 'tasks:complete_task' task.id %}"
                                      class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="next" value="employee_dashboard">
                                    <button type="submit"
                                            class="btn btn-success btn-sm"
                                            onclick="return confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é?')">
                                        ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                    </button>
                                </form>
                                {% endif %}

                                <a href="{% url 'tasks:task_detail' task.id %}"
                                   class="btn btn-info btn-sm">
                                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </a>
                            </td>
                        </tr>
                        {% endfor %}

                        {% for task in active_tasks|slice:":5" %}
                        {% if not task.is_overdue %}
                        <tr>
                            <td>
                                <strong>{{ task.title }}</strong>
                                {% if task.description %}
                                <br><small class="text-muted">{{ task.description|truncatechars:50 }}</small>
                                {% endif %}
                            </td>
                            <td>{{ task.project.name|default:"–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞" }}</td>
                            <td>
                                <span class="badge bg-warning">
                                    {{ task.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if task.due_date %}
                                    {{ task.due_date|date:"d.m.Y" }}
                                    {% if task.due_date == today %}
                                    <br><small class="text-warning">–°–µ–≥–æ–¥–Ω—è!</small>
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if task|can_complete_task:user and task.status != 'done' %}
                                <form method="post"
                                      action="{% url 'tasks:complete_task' task.id %}"
                                      class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="next" value="employee_dashboard">
                                    <button type="submit"
                                            class="btn btn-success btn-sm"
                                            onclick="return confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é?')">
                                        ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                    </button>
                                </form>
                                {% endif %}

                                <a href="{% url 'tasks:task_detail' task.id %}"
                                   class="btn btn-info btn-sm">
                                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if overdue_tasks.count > 5 or active_tasks.count > 5 %}
            <div class="text-center mt-3">
                <a href="{% url 'tasks:my_tasks' %}" class="btn btn-outline-primary">
                    üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ ({{ tasks.count }})
                </a>
            </div>
            {% endif %}

            {% else %}
            <div class="text-center py-4">
                <h4>üéâ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</h4>
                <p class="text-muted">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.</p>
                <a href="{% url 'tasks:my_tasks' %}" class="btn btn-outline-success">
                    üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
    {% if completed_tasks %}
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for task in completed_tasks|slice:":6" %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100 border-success">
                        <div class="card-body">
                            <h6 class="card-title">{{ task.title }}</h6>
                            <p class="card-text small text-muted">
                                {{ task.description|truncatechars:80|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    üìÖ {{ task.updated_at|date:"d.m.Y" }}
                                </small>
                                <span class="badge bg-success">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if completed_tasks.count > 6 %}
            <div class="text-center mt-3">
                <a href="{% url 'tasks:my_tasks' %}?status=done" class="btn btn-outline-success">
                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ ({{ completed_tasks.count }})
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<style>
.table-danger {
    background-color: rgba(220, 53, 69, 0.1);
}
.card-header .badge {
    font-size: 0.8em;
}
</style>
{% endblock %}
