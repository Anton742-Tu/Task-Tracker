name: Django CI/CD

on: [push, pull_request]

env:
  PYTHON_VERSION: '3.12'
  DJANGO_SETTINGS_MODULE: 'config.settings.testing'

jobs:
  lint-and-format:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install black==23.11.0 flake8==6.1.0 mypy==1.7.0 pre-commit

    - name: Check formatting with Black
      run: |
        black --check --config pyproject.toml .

    - name: Lint with flake8
      run: |
        flake8 --config .flake8 .

    - name: Type checking with mypy
      run: |
        mypy --config-file pyproject.toml .

    - name: Run pre-commit checks
      run: |
        pre-commit run --all-files

  test:
    runs-on: ubuntu-latest
    needs: lint-and-format

    env:
      DJANGO_SETTINGS_MODULE: config.settings.testing
      SECRET_KEY: test-secret-key-for-ci-12345
      DEBUG: "False"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-django pytest-cov coverage

    - name: Check for missing migrations
      run: |
        python manage.py makemigrations --check --dry-run

    - name: Run migrations
      run: |
        python manage.py migrate --no-input

    - name: Run tests with pytest
      run: |
        python -m pytest \
          --ds=config.settings.testing \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --disable-warnings \
          -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: success()
      with:
        file: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false

    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          coverage.xml
          htmlcov/
        retention-days: 7

  security-scan:
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install security scanners
      run: |
        pip install bandit safety

    - name: Run bandit security scan
      run: |
        bandit -r . -f json -o bandit-report.json || true

    - name: Run safety check
      run: |
        safety check --json -o safety-report.json || true

    - name: Archive security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 7

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      if: github.ref == 'refs/heads/main'
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: ${{ github.ref == 'refs/heads/main' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/task-tracker:latest
          ${{ secrets.DOCKER_USERNAME }}/task-tracker:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker run --rm \
          -e DJANGO_SETTINGS_MODULE=config.settings.testing \
          -e SECRET_KEY=test-key \
          ${{ secrets.DOCKER_USERNAME }}/task-tracker:latest \
          python -c "import django; print(f'Django version: {django.__version__}')"

  deploy-staging:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/develop'

    steps:
    - name: Deploy to staging
      run: |
        echo "üöÄ Deploying to staging environment..."
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–ª–æ–π –Ω–∞ staging —Å–µ—Ä–≤–µ—Ä
        # –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ SSH –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä–≤–∏—Å —Ç–∏–ø–∞ Railway/Render

  deploy-production:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to production
      run: |
        echo "üöÄ Deploying to production environment..."
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä
        # –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ SSH:
        # ssh user@server "docker pull image && docker-compose up -d"

  docs:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Generate OpenAPI schema
      run: |
        python manage.py spectacular --file docs/schema.yml --format yaml

    - name: Commit and push API docs
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'

        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é docs –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        mkdir -p docs

        git add docs/schema.yml

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --staged --quiet; then
          echo "üìÑ No changes to API docs"
        else
          git commit -m "üìö docs: update API documentation [skip ci]"
          git push
          echo "‚úÖ API docs updated successfully"
        fi
